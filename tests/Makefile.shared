
TMP_FILE=tmp.log
PROOF_FILE=proof.v
SCRIPT_FILE=script.v
TERM_FILE=term.v
NORM_FILE=norm.v

FLAGS=-t 5s

all: $(TESTS)
	@echo -e "\033[2K\r\e[32m[OK]\e[0m [$(NAME)]"

%.res: % $(BIN)
	@echo -ne "\033[2K\r$(NAME) -- $<"
	@if ! $(BIN) $(FLAGS) $(OPT) $< > $(TMP_FILE); then 							\
			echo -e "\033[2K\r\e[31m[KO]\e[0m [$(NAME)] $<";			\
			echo -e "$(BIN) $(FLAGS) $(OPT) $<";									\
			cat $(TMP_FILE);																			\
			exit 1;																			\
		fi

%.sat: % $(BIN)
	@echo -ne "\033[2K\r$(NAME) -- $<"
	@if ! $(BIN) $(FLAGS) $(OPT) $< | tee $(TMP_FILE) | grep Unsat > /dev/null; then 							\
			echo -e "\033[2K\r\e[31m[KO]\e[0m [$(NAME)] $<";			\
			echo -e "$(BIN) $(FLAGS) $(OPT) $<";									\
			cat $(TMP_FILE);																			\
			exit 1;																			\
		fi

%.unsat: % $(BIN)
	@echo -ne "\033[2K\r$(NAME) -- $<"
	@if ! $(BIN) $(FLAGS) $(OPT) $< | tee $(TMP_FILE) | grep Unsat > /dev/null; then 	\
			echo -e "\033[2K\r\e[31m[KO]\e[0m [$(NAME)] $<";							\
			echo -e "$(BIN) $(FLAGS) $(OPT) $<";													\
			cat $(TMP_FILE);																			\
			exit 1;																							\
		fi

%.coq: % $(BIN)
	@echo -ne "\033[2K\r$(NAME) -- coq -- $<"
	@if ! $(BIN) $(FLAGS) $(OPT) --coq $(PROOF_FILE) --coqscript $(SCRIPT_FILE) $< > $(TMP_FILE); then 		\
			echo -e "\033[2K\r\e[31m[FAIL]\e[0m [$(NAME)] $<";											\
			echo -e "$(BIN) $(FLAGS) $(OPT) --coq $(PROOF_FILE) --coqscript $(SCRIPT_FILE) $<"; \
			cat $(TMP_FILE);																			\
			exit 1;																											\
		fi
	@if ! coqc $(PROOF_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coq]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(PROOF_FILE)";							\
			exit 1;																											\
		fi
	@if ! coqc $(SCRIPT_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coq]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(SCRIPT_FILE)";							\
			exit 1;																											\
		fi

%.coqfull: % $(BIN)
	@echo -ne "\033[2K\r$(NAME) -- coq -- $<"
	@if ! $(BIN) $(FLAGS) $(OPT) --coq $(PROOF_FILE) --coqscript $(SCRIPT_FILE) --coqterm $(TERM_FILE) --coqnorm $(NORM_FILE) $< > $(TMP_FILE); then 		\
			echo -e "\033[2K\r\e[31m[FAIL]\e[0m [$(NAME)] $<";											\
			echo -e "$(BIN) $(FLAGS) $(OPT) --coq $(PROOF_FILE) --coqscript $(SCRIPT_FILE) --coqterm $(TERM_FILE) --coqnorm $(NORM_FILE) $<"; \
			cat $(TMP_FILE);																			\
			exit 1;																											\
		fi
	@if ! coqc $(PROOF_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coq]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(PROOF_FILE)";							\
			exit 1;																											\
		fi
	@if ! coqc $(SCRIPT_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coq]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(SCRIPT_FILE)";							\
			exit 1;																											\
		fi
	@if ! coqc $(TERM_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coqterm]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(TERM_FILE)";							\
			exit 1;																											\
		fi
	@if ! coqc $(NORM_FILE) &> /dev/null; then											\
			echo -e "\033[2K\r\e[31m[coqnorm]\e[0m [$(NAME)] $<";										\
			echo -e "coqc $(NORM_FILE)";							\
			exit 1;																											\
		fi

clean:
	rm -rf *.res *.sat *.unsat *.coq $(TMP_FILE) *$(PROOF_FILE)* *$(SCRIPT_FILE)* *$(TERM_FILE)* *$(NORM_FILE)* *.vo *.glob

